from sentence_transformers import SentenceTransformer
from sklearn.cluster import AgglomerativeClustering
import numpy as np
import pandas as pd
from dataloader import InitiativeExcelLoader
import os
import pickle

def get_nc_clusters():
    path = 'nc_clusters.pickle'
    if os.path.isfile(path):
        with open(path, "rb") as f:
            try:
                return pickle.load(f)
            except Exception: # so many things could go wrong, can't be more specific.
                print('Error occured while loading nc_clusters.pickle file') 
    else:
        embedder = SentenceTransformer('paraphrase-MiniLM-L6-v2')
        dataloader = InitiativeExcelLoader()
        dataset = pd.DataFrame(dataloader.dataset['test'])
        m = dataset['true_strong'].tolist()
        # nc_oc = dataset['true_nc_oc'].tolist()
        #print('reviews:', r)
        #print('true_nc:', m)

        set_m = {}

        for index in range(len(m)):
            for item in m[index].split(', '):
                item = item.strip().lower()
                if item in set_m:
                    set_m[item].add(index)
                else:
                    set_m[item] = {index}

        #print(set_m)
        nc_list = list(set_m.keys())
        #nc_list.remove('none')
        '''
        corpus_embeddings = embedder.encode(nc_list)

        # Normalize the embeddings to unit length
        corpus_embeddings = corpus_embeddings /  np.linalg.norm(corpus_embeddings, axis=1, keepdims=True)

        # Perform kmean clustering
        clustering_model = AgglomerativeClustering(n_clusters = None, distance_threshold=1.3) #, affinity='cosine', linkage='average', distance_threshold=0.4)
        clustering_model.fit(corpus_embeddings)
        cluster_assignment = clustering_model.labels_

        print(cluster_assignment)
        max_key = max(cluster_assignment)
        cluster_assignment = np.append(cluster_assignment, max_key+1)
        '''
        # Manual cluster assignment
        #cluster_assignment = {0: {'cutest little piglet', 'baby alligator', 'rooster', 'peacocks', 'manatee', 'gators', 'clydesdales horses', 'anaconda', 'animals', 'pigs', 'goat', 'your pets', 'hounds', "their 'petting zoo'", 'local wildlife'}, 1: {'keno', 'computer football', 'madden 15', 'nfl blitz 99', 'computer nascar style racing', 'big connect 4', 'jenga', 'shuffleboard', 'life size beer pong', 'table and floor games', 'pool table', 'games', 'arcade games', 'board games', 'zombie dodgeball', 'ping pong', 'beach volleyball', 'badminton', 'quizo', 'trivia pursuit', 'virtual golf', 'mini trampoline', 'trivia night'}, 2: {'awesome skateboard deck'}, 3: {'casinos', 'lottery tickets/ scratchers', 'scratch off lottery machine'}, 4: {'moms', 'activists', 'hackers', 'anarchists'}, 5: {'drag show', 'balloon puppets', 'mark the balloon guy', 'stuffed animal/puppets', 'puppet show', 'hypnosis show'}, 6: {'local charity', 'outreach program', 'meal sponsorship program'}, 7: {'arizona greyhound rescue event', 'adoption', 'community scarf/blanket project', 'stray cat alliance'}, 8: {'hummingbirds', 'songbirds', 'parakeet paradise'}, 9: {'park woods', 'parklands', 'goose creek park'}, 10: {'journals', 'guidebook', 'used books', 'a guide on planetary leadership', 'basics of mechanical engineering'}, 11: {'book exchange area', 'paper studio'}, 12: {'their museum', 'collectibles', 'their extensive collection', 'red wine collection'}, 13: {'deck'}, 14: {'tank'}, 15: {'cellar room', 'lounge area', 'their apothecary area'}, 16: {'nice playroom', 'playground'}, 17: {'wifi', 'free wifi', 'internet'}, 18: {'ponchos'}, 19: {'henna artist', 'henna tattoo artist', 'local artist', 'local artists', 'fortune teller', 'stand-up comic'}, 20: {'professional babysitting service'}, 21: {'indy 500 photos', 'photo booth', 'polaroid'}, 22: {'custom associations', 'symbolism', 'culturally amazing german experience', 'history lesson'}, 23: {'canoeing', 'kayaking', 'paddle cruise', 'airboat ride'}, 24: {'beautiful garden', 'garden', 'organic gardeners', 'plants', 'adjacent garden'}, 25: {'10 dollar fresh day tour', 'their tour', 'amazing tour de bier', 'tour', 'free tour'}, 26: {'video', 'audiobook'}, 27: {'gift shop', 'bookstore/gift shop', 'cute indoor store', 'little grocery store'}, 28: {'greeting cards', 'gift tags', 'anniversary gifts', 'lip balms', 'shawl', 'their candles', 'candles', 'necklace', 'cute wallet', 'customized carmel sportswear'}, 29: {'gorgeous waves', 'shore'}, 30: {'open air beach view', 'sunset'}, 31: {'ava amphitheater', 'music venue', 'their nightclub', 'karaoke venue'}, 32: {'concert', 'entertainment', 'performances', 'small concerts', 'karaoke night', 'live music', 'best sounding band', 'live bands'}, 33: {'derek st. holmes'}, 34: {'nasty blues'}, 35: {'activities', 'hikes', 'river walk'}, 37: {'fireworks', 'fire', 'penns landing fireworks'}, 38: {'dolphin spotting', 'sunny fish', 'fishies'}, 39: {'water', 'dock area', 'dock', 'long public dock'}, 40: {'boaters', 'jet powered surfboard surfers', 'kite surfers'}, 41: {'cemetery', 'estate'}, 42: {'events', 'really good events', 'special event'}, 43: {'watercolors', 'great therapeutic sketching', 'art'}, 44: {'orange cat', 'cats'}, 45: {'circus', 'carnival'}, 46: {'bollywood movies'}, 47: {'different size diapers'}, 48: {'on site medium'}, 49: {'huge skater', 'his own skating company'}, 50: {'terrariums', 'beautiful pots'}, 51: {'sunbathers'}, 52: {'souvenir t-shirts', 'hats,"hi af" shirt'}, 53: {'free comic'}, 54: {'golf course'}, 55: {'philly community acupuncture'}, 56: {'movie good burger', 'good burger car'}, 57: {'free calendar'}, 58: {'pokestop', 'pokestops'}, 59: {'yoga', 'capoiera/zumba studio', 'dance floors'}, 60: {'glass'}, 61: {'coffee grounds'}, 62: {'tips'}, 63: {'entrance fee'}, 64: {'none', ''}}
        #cluster_assignment = {0: {'cutest little piglet', 'baby alligator', 'rooster', 'peacocks', 'manatee', 'gators', 'clydesdales horses', 'anaconda', 'animals', 'pigs', 'goat', 'your pets', 'pet-friendly', 'hounds', "their 'petting zoo'", 'local wildlife'}, 1: {'keno', 'computer football', 'madden 15', 'nfl blitz 99', 'computer nascar style racing', 'big connect 4', 'jenga', 'shuffleboard', 'life size beer pong', 'table and floor games', 'pool table', 'games', 'arcade games', 'board games', 'zombie dodgeball', 'ping pong', 'beach volleyball', 'badminton', 'quizo', 'trivia pursuit', 'virtual golf', 'mini trampoline', 'trivia night', 'giant jenga', 'bowling alley', 'darts'}, 2: {'awesome skateboard deck'}, 3: {'casinos', 'lottery tickets/ scratchers', 'scratch off lottery machine'}, 4: {'moms', 'activists', 'hackers', 'anarchists'}, 5: {'drag show', 'balloon puppets', 'mark the balloon guy', 'stuffed animal/puppets', 'puppet show', 'hypnosis show'}, 6: {'local charity', 'outreach program', 'meal sponsorship program', 'liberal arts camps', 'great program'}, 7: {'arizona greyhound rescue event', 'adoption', 'community scarf/blanket project', 'stray cat alliance'}, 8: {'hummingbirds', 'songbirds', 'parakeet paradise'}, 9: {'park woods', 'parklands', 'goose creek park'}, 10: {'journals', 'guidebook', 'used books', 'a guide on planetary leadership', 'basics of mechanical engineering'}, 11: {'book exchange area', 'paper studio'}, 12: {'their museum', 'collectibles', 'their extensive collection', 'red wine collection'}, 13: {'deck'}, 14: {'tank'}, 15: {'cellar room', 'lounge area', 'their apothecary area'}, 16: {'nice playroom', 'playground'}, 17: {'wifi', 'free wifi', 'internet', 'free wireless'}, 18: {'ponchos'}, 19: {'henna artist', 'henna tattoo artist', 'local artist', 'local artists', 'fortune teller', 'stand-up comic', 'caricature artist', 'piano player', 'great singer', 'regular bellydancer', 'painters', 'face painter', 'wonderful painter', 'other painters', 'new artists', 'pop/electric/rap one-man singers'}, 20: {'professional babysitting service'}, 21: {'indy 500 photos', 'photo booth', 'polaroid', 'pictures'}, 22: {'custom associations', 'symbolism', 'culturally amazing german experience', 'history lesson'}, 23: {'canoeing', 'kayaking', 'paddle cruise', 'airboat ride'}, 24: {'beautiful garden', 'garden', 'organic gardeners', 'plants', 'adjacent garden', 'their small attached nursery', 'avocado tree', 'beautiful orange tree', 'large birch branches', 'garden of flowers', 'canopy of trees'}, 25: {'10 dollar fresh day tour', 'their tour', 'amazing tour de bier', 'tour', 'free tour', '"grapes and hops" tour'}, 26: {'video', 'audiobook'}, 27: {'gift shop', 'bookstore/gift shop', 'cute indoor store', 'little grocery store', 'cute little paint your own ceramic shop', 'lobby wine gift shop', 'gift shopping', 'boutique'}, 28: {'greeting cards', 'gift tags', 'anniversary gifts', 'lip balms', 'shawl', 'their candles', 'candles', 'necklace', 'cute wallet', 'customized carmel sportswear', 'unique gifts', 'jewelry', 'car dangles', 'cards', 'accessories', 'clothing'}, 29: {'gorgeous waves', 'shore'}, 30: {'open air beach view', 'sunset', 'waterfront views'}, 31: {'ava amphitheater', 'music venue', 'their nightclub', 'karaoke venue', 'best piano bar', 'piano room'}, 32: {'concert', 'entertainment', 'performances', 'small concerts', 'karaoke night', 'live music', 'best sounding band', 'live bands', 'terrible dj', 'nice band', 'over-zealous wannabe-in-ibiza dj', 'open mic', 'songwriters night'}, 33: {'derek st. holmes', 'dj extraordinaire', 'cliff', 'band'}, 34: {'nasty blues'}, 35: {'activities', 'hikes', 'river walk', 'lesson'}, 37: {'fireworks', 'fire', 'penns landing fireworks'}, 38: {'dolphin spotting', 'sunny fish', 'fishies'}, 39: {'water', 'dock area', 'dock', 'long public dock'}, 40: {'boaters', 'jet powered surfboard surfers', 'kite surfers'}, 41: {'cemetery', 'estate'}, 42: {'events', 'really good events', 'special event', 'local upcoming events'}, 43: {'watercolors', 'great therapeutic sketching', 'art'}, 44: {'orange cat', 'cats'}, 45: {'circus', 'carnival'}, 46: {'bollywood movies'}, 47: {'different size diapers'}, 48: {'on site medium'}, 49: {'huge skater', 'his own skating company'}, 50: {'terrariums', 'beautiful pots'}, 51: {'sunbathers'}, 52: {'souvenir t-shirts', 'hats,"hi af" shirt', 't-shirt'}, 53: {'free comic'}, 54: {'golf course'}, 55: {'philly community acupuncture'}, 56: {'movie good burger', 'good burger car'}, 57: {'free calendar'}, 58: {'pokestop', 'pokestops'}, 59: {'capoiera/zumba studio'}, 60: {'glass'}, 61: {'coffee grounds'}, 62: {'tips'}, 63: {'entrance fee'}, 64: {'none', ''}, 65: {'porn'}, 66: {'acts'}, 67: {'salsa', 'bachata', 'merengue', 'cha cha cha dancers'}, 68: {'donation yoga classes', 'yoga', 'meditation groups', 'yoga & meditation'}, 69: {'dance floors', 'dance floor'}, 70: {'film nights & art exhibits/events'}, 71: {'latte art offs'}, 72: {'great bird watching'}, 73: {'confections'}, 74: {'reusable shopping bag'}, 75: {'balloon sculpture'}, 76: {'spot'}, 77: {'large paintings'}, 78: {'group meetings'}, 79: {'asian market'}, 80: {'piano & keyboards'}, 81: {'ceramics'}, 82: {'paint supplies'}, 83: {'tools'}}
        cluster_assignment = {0: {'cutest little piglet', 'baby alligator', 'rooster', 'peacocks', 'manatee', 'gators', 'clydesdales horses', 'anaconda', 'animals', 'pigs', 'goat', 'your pets', 'pet-friendly', 'hounds', "their 'petting zoo'", 'local wildlife', 'cow', 'indoor cat petting zoo', 'cat caf√©'}, 1: {'keno', 'computer football', 'madden 15', 'nfl blitz 99', 'computer nascar style racing', 'big connect 4', 'jenga', 'shuffleboard', 'life size beer pong', 'table', 'floor games', 'pool table', 'games', 'arcade games', 'board games', 'zombie dodgeball', 'ping pong', 'beach volleyball', 'badminton', 'quizo', 'trivia pursuit', 'virtual golf', 'mini trampoline', 'trivia night', 'giant jenga', 'bowling alley', 'darts'}, 2: {'awesome skateboard deck'}, 3: {'casinos', 'lottery tickets/scratchers', 'scratch off lottery machine', 'casino'}, 4: {'moms', 'activists', 'hackers', 'anarchists'}, 5: {'drag show', 'balloon puppets', 'mark the balloon guy', 'stuffed animal/puppets', 'puppet show', 'hypnosis show', 'interesting giant stuffed spider', 'drag shows'}, 6: {'local charity', 'outreach program', 'meal sponsorship program', 'liberal arts camps', 'great program', 'big community impact', 'local community'}, 7: {'arizona greyhound rescue event', 'adoption', 'community scarf/blanket project', 'stray cat alliance'}, 8: {'hummingbirds', 'songbirds', 'parakeet paradise'}, 9: {'park woods', 'parklands', 'goose creek park'}, 10: {'journals', 'guidebook', 'used books', 'a guide on planetary leadership', 'basics of mechanical engineering'}, 11: {'book exchange area', 'paper studio'}, 12: {'their museum', 'collectibles', 'their extensive collection', 'red wine collection', 'mini museum'}, 13: {'deck'}, 14: {'tank'}, 15: {'cellar room', 'lounge area', 'their apothecary area', 'nice trendy lounge', 'section', 'side cubicles'}, 16: {'nice playroom', 'playground'}, 17: {'wifi', 'free wifi', 'internet', 'free wireless'}, 18: {'ponchos'}, 19: {'henna artist', 'henna tattoo artist', 'local artist', 'local artists', 'fortune teller', 'stand-up comic', 'caricature artist', 'piano player', 'great singer', 'regular bellydancer', 'painters', 'face painter', 'wonderful painter', 'other painters', 'new artists', 'pop/electric/rap one-man singers', 'caricature man', 'female vocalist'}, 20: {'professional babysitting service'}, 21: {'indy 500 photos', 'photo booth', 'polaroid', 'pictures'}, 22: {'custom associations', 'symbolism', 'culturally amazing german experience', 'history lesson'}, 23: {'canoeing', 'kayaking', 'paddle cruise', 'airboat ride'}, 24: {'beautiful garden', 'garden', 'organic gardeners', 'plants', 'adjacent garden', 'their small attached nursery', 'avocado tree', 'beautiful orange tree', 'large birch branches', 'garden of flowers', 'canopy of trees', 'big plants', 'garish christmas tree'}, 25: {'10 dollar fresh day tour', 'their tour', 'amazing tour de bier', 'tour', 'free tour', '"grapes and hops" tour'}, 26: {'video', 'audiobook'}, 27: {'gift shop', 'bookstore/gift shop', 'cute indoor store', 'little grocery store', 'cute little paint your own ceramic shop', 'lobby wine gift shop', 'gift shopping', 'boutique', 'great boutique', 'little shop/deli'}, 28: {'greeting cards', 'gift tags', 'anniversary gifts', 'lip balms', 'shawl', 'their candles', 'candles', 'necklace', 'cute wallet', 'customized carmel sportswear', 'unique gifts', 'jewelry', 'car dangles', 'cards', 'accessories', 'clothing'}, 29: {'gorgeous waves', 'shore'}, 30: {'open air beach view', 'sunset', 'waterfront views'}, 31: {'ava amphitheater', 'music venue', 'their nightclub', 'karaoke venue', 'best piano bar', 'piano room'}, 32: {'concert', 'entertainment', 'performances', 'small concerts', 'karaoke night', 'live music', 'best sounding band', 'live bands', 'terrible dj', 'nice band', 'over-zealous wannabe-in-ibiza dj', 'open mic', 'songwriters night', 'band', 'lively fun band'}, 33: {'derek st. holmes', 'dj extraordinaire', 'cliff', }, 34: {'nasty blues'}, 35: {'activities', 'hikes', 'river walk', 'lesson'}, 37: {'fireworks', 'fire', 'penns landing fireworks'}, 38: {'dolphin spotting', 'sunny fish', 'fishies'}, 39: {'water', 'dock area', 'dock', 'long public dock', "sparkman's warf", 'channelside'}, 40: {'boaters', 'jet powered surfboard surfers', 'kite surfers'}, 41: {'cemetery', 'estate'}, 42: {'events', 'really good events', 'special event', 'local upcoming events'}, 43: {'watercolors', 'great therapeutic sketching', 'art', 'artwork', 'ancient art', 'large paintings', 'no paintings', 'caricatures'}, 44: {'orange cat', 'cats'}, 45: {'circus', 'carnival'}, 46: {'bollywood movies'}, 47: {'different size diapers'}, 48: {'on site medium'}, 49: {'huge skater', 'his own skating company'}, 50: {'terrariums', 'beautiful pots'}, 51: {'sunbathers'}, 52: {'souvenir t-shirts', 'hats', '"hi af" shirt', 't-shirt'}, 53: {'free comic'}, 54: {'golf course'}, 55: {'philly community acupuncture'}, 56: {'movie good burger', 'good burger car'}, 57: {'free calendar'}, 58: {'pokestop', 'pokestops'}, 59: {'capoiera/zumba studio'}, 60: {'glass'}, 61: {'coffee grounds'}, 62: {'tips'}, 63: {'entrance fee'}, 64: {'none', ''}, 65: {'porn'}, 66: {'acts'}, 67: {'salsa', 'bachata', 'merengue', 'cha cha cha dancers', 'dumb macarena', 'cotton eye joe', 'dancing every 10 minutes'}, 68: {'donation yoga classes', 'yoga', 'meditation groups', 'yoga & meditation'}, 69: {'dance floors', 'dance floor'}, 70: {'film nights & art exhibits/events'}, 71: {'latte art offs'}, 72: {'great bird watching'}, 73: {'confections'}, 74: {'reusable shopping bag'}, 75: {'balloon sculpture', 'decorative balloon hats'}, 76: {'spot'}, 77: {'fabrics'}, 78: {'group meetings'}, 79: {'asian market'}, 80: {'piano & keyboards'}, 81: {'ceramics'}, 82: {'paint supplies'}, 83: {'tools'}, 84: {'their wall', 'floor-to-ceiling panes of glass', 'reclaimed wide wooden floors', 'wall', 'floating fireplace'}, 85: {'old nine-inch t.v.', 'old-school cassette tape ghetto-blaster', 'old antique door', 'converted wine cask', 'kitsch', 'kitschy coffee-stained book', 'retro eye-sore'}, 86: {'witchy wares'}, 87: {'teacup collections'}, 88: {'japanese techno', 'bossa nova'}, 89: {'colorful shipping containers', 'colourful curtains', 'cushions', 'big pillows'}, 90: {"al gore's tobacco barn"}, 91: {'bohemian & authentic', 'urban vibe', 'vintage feel', 'english pub feel', 'elk island /kananaskis mountain/lake outdoor feel', 'cool'}, 92: {'glowing lights', 'giant moon', 'neon signs', 'chandeliers', 'electric chandeliers', 'mason jars'}, 93: {'hand-carved wooden replicas of the native birds of louisiana'}, 94: {'converted double-decker bus', 'alien spaceship'}, 95: {'safari', 'sports theme', 'reno', 'sparks themed', 'sports'}, 96: {'traditional wooden baseball stadium seats', 'balcony seating', 'wood crafted art pieces', 'decor'}, 97: {'yoda', 'star wars memorabilia'}, 98: {'their sister restaurant', "uno's", 'old mazda dealership', 'painters alley'}, 99: {'mexican music', 'house music'}}



        print(cluster_assignment)
        nc_cluster_map = {}
        nc_list.append('none')
        #print(nc_list)
        '''
        for item, cluster in zip(nc_list, cluster_assignment):
            nc_cluster_map[item] = cluster
        '''
        for cluster, ncs in cluster_assignment.items():
            for nc in ncs:
                nc_cluster_map[nc] = cluster
                 
        print(nc_cluster_map)
        with open(path, "wb") as f:
            pickle.dump(nc_cluster_map, f, pickle.HIGHEST_PROTOCOL)
        return nc_cluster_map
    
    